name: Update README with latest release version

on:
  release:
    types: [published]

permissions:
  contents: write  # Needed to push changes back

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.repository.default_branch }}

      - name: Determine version from tag
        id: get_tag
        run: |
          echo "RELEASE_TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Update README.md with new version
        env:
          VERSION: ${{ env.RELEASE_TAG }}
        run: |
          set -euo pipefail
          FILE="README.md"

          # Windows: releases/download/<tag>/mydylms-client-v<tag>-win-x64.exe
          sed -i -E "s#(releases/download/)[^/]+(/mydylms-client-v)[^/]+(-win-x64\.exe)#\1${VERSION}\2${VERSION}\3#g" "$FILE"

          # Linux: handle both releases/download and releases/tag links, optional .tar.gz
          sed -i -E "s#(releases/(download|tag)/)[^/]+(/mydylms-client-v)[^/]+(-linux-x86__64(\.tar\.gz)?)#\1${VERSION}\3${VERSION}\4#g" "$FILE"

          # macOS: allow optional .zip suffix
          sed -i -E "s#(releases/download/)[^/]+(/mydylms-client-v)[^/]+(-macos-arm64(\.zip)?)#\1${VERSION}\2${VERSION}\3#g" "$FILE"

      - name: Commit and push changes
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          VERSION: ${{ env.RELEASE_TAG }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          git commit -m "chore(docs): update download links to ${VERSION}"
          git pull --rebase origin "${DEFAULT_BRANCH}"
          git push origin HEAD:"${DEFAULT_BRANCH}"
