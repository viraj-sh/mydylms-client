name: Test Release Executables

on:
  workflow_run:
    workflows: ["Build Executables"]
    types:
      - completed

permissions:
  contents: read

jobs:
  determine:
    name: Check if Build Was for Tag
    runs-on: ubuntu-latest
    outputs:
      should_test: ${{ steps.check.outputs.should_test }}

    steps:
      - id: check
        name: Determine if build should be tested
        run: |
          echo "Event: ${{ github.event.workflow_run.event }}"
          if [ "${{ github.event.workflow_run.event }}" = "push" ] &&
             [[ "${{ github.event.workflow_run.head_branch }}" == refs/tags/* ]]; then
            echo "should_test=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_test=false" >> "$GITHUB_OUTPUT"
          fi

  # -------------------------
  # Windows Test Job
  # -------------------------
  test-windows:
    name: Test Windows Release
    needs: determine
    if: needs.determine.outputs.should_test == 'true'
    runs-on: windows-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Locate Windows binary
        id: find
        shell: pwsh
        run: |
          $file = Get-ChildItem -Recurse -Filter "*win-x64.exe" | Select-Object -First 1
          if (-Not $file) { Write-Error "Windows binary not found" }
          echo "exe_path=$($file.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Start server
        shell: pwsh
        run: |
          Start-Process -FilePath "${{ steps.find.outputs.exe_path }}" -WindowStyle Hidden
          Start-Sleep -Seconds 5

      - name: Test /api/v1/health
        shell: pwsh
        run: |
          try {
            $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/v1/health" -UseBasicParsing -TimeoutSec 5
            if ($response.StatusCode -ne 200) {
              Write-Error "Health check failed with status code $($response.StatusCode)"
            }
          } catch {
            Write-Error "Health check failed: $_"
          }

      - name: Stop server
        shell: pwsh
        continue-on-error: true
        run: |
          Get-Process | Where-Object { $_.ProcessName -like "mydylms*" } | Stop-Process -Force

  # -------------------------
  # macOS Test Job
  # -------------------------
  test-macos:
    name: Test macOS Release
    needs: determine
    if: needs.determine.outputs.should_test == 'true'
    runs-on: macos-14

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Locate macOS binary
        id: find
        run: |
          file=$(find . -type f -name "*macos-arm64" | head -n 1)
          if [ -z "$file" ]; then
            echo "macOS binary not found" >&2
            exit 1
          fi
          echo "exe_path=$file" >> $GITHUB_OUTPUT

      - name: Make executable
        run: chmod +x "${{ steps.find.outputs.exe_path }}"

      - name: Start server
        run: |
          "${{ steps.find.outputs.exe_path }}" &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          sleep 5

      - name: Test /api/v1/health
        run: |
          for i in {1..10}; do
            curl -sf "http://127.0.0.1:8000/api/v1/health" && exit 0
            echo "Waiting for server..."
            sleep 1
          done
          echo "Health check failed" >&2
          exit 1

      - name: Stop server
        if: always()
        run: |
          kill -9 $SERVER_PID || true